#!/bin/bash -eu

set -e -x

source bosh-env/set-env.sh

export CA_CERT="$PWD/bosh-env/ca-cert.pem"
#export BBR_PRIVATE_KEY=$(cat bosh-env/ssh-key)

export DEPLOYMENT_TO_BACKUP=cf
export DEPLOYMENT_TO_RESTORE=cf
export BOSH_URL=${BOSH_ENVIRONMENT}
export BOSH_CLIENT=${BOSH_CLIENT}
export BOSH_CLIENT_SECRET=${BOSH_CLIENT_SECRET}
export BOSH_CERT_PATH=${CA_CERT}
export BBR_BUILD_PATH=$(pwd)/binary/bbr

# install glide because drats doesn't
curl https://glide.sh/get | sh

#install bosh
wget https://s3.amazonaws.com/bosh-cli-artifacts/bosh-cli-2.0.28-linux-amd64
chmod +x bosh-cli-*
sudo mv bosh-cli-* /usr/local/bin/bosh-cli

#install cf cli
wget -O cf-cli.deb "https://cli.run.pivotal.io/stable?release=debian64&source=github"
dpkg -i cf-cli.deb && apt-get install -f

#wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
#echo "deb http://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
#sudo apt-get update
#sudo apt-get install cf-cli

# make a go project

cp -r drats $GOPATH/src/cloudfoundry-incubator/disaster-recovery-acceptance-tests
mkdir -p runme
pushd runme/
    export GOPATH=$PWD
    export PATH=$GOPATH/bin:$PATH

    go get github.com/cloudfoundry-incubator/disaster-recovery-acceptance-tests
    go get github.com/jeffpak/disaster-recovery-acceptance-tests

    # run drats
    pushd src/github.com/jeffpak/disaster-recovery-acceptance-tests/
        scripts/run_acceptance_tests.sh
    popd
popd
